<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<title>
关于pandas.DataFrame.copy()的小坑 - DRAPORLAND
</title>











<link rel="stylesheet" href="/css/main.min.81bbafc4df93b11c1c3e2449464373c384aa4903731b4fc7a77dfcdd979e184f.css" integrity="sha256-gbuvxN&#43;TsRwcPiRJRkNzw4SqSQNzG0/Hp3383ZeeGE8=" crossorigin="anonymous" media="screen">



 

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="关于pandas.DataFrame.copy()的小坑"/>
<meta name="twitter:description" content="最近发现了一个关于pandas.DataFrame.copy()的小坑，特此小记；"/>

<meta property="og:title" content="关于pandas.DataFrame.copy()的小坑" />
<meta property="og:description" content="最近发现了一个关于pandas.DataFrame.copy()的小坑，特此小记；" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://drapor.me/posts/180805_pd_deepcopy/" />
<meta property="article:published_time" content="2018-08-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-08-05T00:00:00+00:00" />



    

    
    
    
    <title>
        
        关于pandas.DataFrame.copy()的小坑
        
    </title>
    <style>
        #container .reply-content {
    	    margin-bottom: 10px;
            margin-top: 8px;
            color: #ddd;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="section" id="title">关于pandas.DataFrame.copy()的小坑</div>

        
<div class="section" id="content">
    Sun Aug 05, 2018
    
    <div class="tag-container">
        
        <span class="tag">
            <a href="https://drapor.me/tags/python">
                #Python
            </a>
        </span>
        
    </div>
    
    <hr/>
    <p>最近发现了一个关于pandas.DataFrame.copy()的小坑，特此小记；</p>
<ul>
<li>我使用的pandas的版本：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ff79c6">import</span> pandas <span style="color:#ff79c6">as</span> pd
pd<span style="color:#ff79c6">.</span>_version<span style="color:#ff79c6">.</span>get_versions()

<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;&#34;&#34;</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">{</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">dirty</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">: False,</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c"> </span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">error</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">: None,</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c"> </span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">full-revisionid</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">: </span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">a00154dcfe5057cb3fd86653172e74b6893e337d</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">,</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c"> </span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">version</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">: </span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">0.22.0</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;&#34;&#34;</span></code></pre></div>
<ul>
<li>常规情况：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">a <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame([[<span style="color:#bd93f9">1</span>]])
a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># 1</span>

b <span style="color:#ff79c6">=</span> a<span style="color:#ff79c6">.</span>copy() <span style="color:#6272a4">#.copy(deep=True) as default</span>
b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>
b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># 2</span>
a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># 1</span></code></pre></div>
<ul>
<li>进一步：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">a <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame([[[<span style="color:#bd93f9">1</span>]]])
a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># [1]</span>

b <span style="color:#ff79c6">=</span> a<span style="color:#ff79c6">.</span>copy() <span style="color:#6272a4">#.copy(deep=True) as default</span>
b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> [<span style="color:#bd93f9">2</span>]
b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># [2]</span>
a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># [1]</span></code></pre></div>
<ul>
<li>进而：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">a <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame([[[<span style="color:#bd93f9">1</span>]]])
a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># [1]</span>

b <span style="color:#ff79c6">=</span> a<span style="color:#ff79c6">.</span>copy() <span style="color:#6272a4">#.copy(deep=True) as default</span>
b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>][<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>
b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># [2]</span>
a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># [2]</span></code></pre></div>
<p>嗯，上面最后一行我没有打错，就是[2]。</p>
<p>想了想出现这种情况的原因，应该是因为即使指定了deep=True，但在复制的时候并对其中的list进行deep copy；</p>
<ul>
<li>其他的发现：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">a <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame([[<span style="color:#bd93f9">1</span>]])
<span style="color:#ff79c6">print</span>(a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>][<span style="color:#bd93f9">0</span>])

b <span style="color:#ff79c6">=</span> a<span style="color:#ff79c6">.</span>copy()
b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>
<span style="color:#ff79c6">print</span>(b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>])  <span style="color:#6272a4"># 2</span>
<span style="color:#ff79c6">print</span>(a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>])  <span style="color:#6272a4"># 1</span>

<span style="color:#ff79c6">print</span>(a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">is</span> b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>]) <span style="color:#6272a4"># False</span>
<span style="color:#ff79c6">print</span>(<span style="color:#8be9fd;font-style:italic">id</span>(a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>]) <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">id</span>(b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>])) <span style="color:#6272a4">#True</span>

<span style="color:#6272a4"># ------</span>

a <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame([[[<span style="color:#bd93f9">1</span>]]])
<span style="color:#ff79c6">print</span>(a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>][<span style="color:#bd93f9">0</span>])

b <span style="color:#ff79c6">=</span> a<span style="color:#ff79c6">.</span>copy()
b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>][<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>
<span style="color:#ff79c6">print</span>(b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>]) <span style="color:#6272a4"># [2]</span>
<span style="color:#ff79c6">print</span>(a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>]) <span style="color:#6272a4"># [2]</span>

<span style="color:#ff79c6">print</span>(a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">is</span> b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>])  <span style="color:#6272a4"># True</span>
<span style="color:#ff79c6">print</span>(<span style="color:#8be9fd;font-style:italic">id</span>(a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>]) <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">id</span>(b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>])) <span style="color:#6272a4"># True</span></code></pre></div>
<p>神奇…</p>
<hr>
<p><strong>18.8.10：</strong></p>
<p>​    之前发现了问题之后去GitHub上提了<a href="https://github.com/pandas-dev/pandas/issues/22203">Issues</a>，前几天收到了一位pandas的contributor的回复：</p>
<img src="/article_imgs/pd_issues.png">
<hr>
<p><strong>18.8.13:</strong></p>
<p>​    又得到了另一位开发者的回复，他指出首先.copy(deep=True)在<a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.copy.html">官方文档</a>上已经写到了这一点：</p>
<blockquote>
<p>When deep=True, data is copied but actual Python objects will not be copied recursively, only the reference to the object. This is in contrast to copy.deepcopy in the Standard Library, which recursively copies object data (see examples below).</p>
</blockquote>
<p>他还指出：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#8be9fd;font-style:italic">id</span>(a<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>]) <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">id</span>(b<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">0</span>])</code></pre></div>
<p>这个语句中，</p>
<blockquote>
<p>the Python interpreter could perform the following steps:</p>
<ol>
<li>Evaluate <code>a.loc[0, 0]</code>; then</li>
<li>Get the id of the temporary object created in step 1; then</li>
<li>Evaluate <code>b.loc[0, 0]</code>; then</li>
<li>Get the id of the temporary object created in step 3.</li>
</ol>
<p>If the temporary object created in step 1 is GC'ed in between, the temporary object created in step 3 may be created at the same address. (In CPython, the <code>id</code> function <a href="https://docs.python.org/3/library/functions.html#id">returns the memory address</a> of an object, although this is considered a CPython implementation detail.)</p>
<p>One case see examples of this just using plain old Python objects:</p>
<pre><code>In [13]: id(object()), id(object())
Out[13]: (4763425312, 4763425312)

In [19]: print(object() is object())
False

In [20]: print(id(object()) == id(object()))
True
</code></pre></blockquote>
<p>后来，我又去尝试了一下copy.deepcopy()，发现即使是这个方法，依然不能达到我想要的效果。再次Google之后得到的答案是，只能乖乖地把index和value分别做deepcopy，然后再构造一个新的DataFrame。</p>
</div>


        
<div class="section bottom-menu">
    
<hr />
<p>


    
        <a href="/posts">back</a>
        
            &#183;
        
    

    
        
            <a href="/posts">Posts</a>
        
    
    
        
            &#183; 
            <a href="/scribble">Scribbles</a>
        
            &#183; 
            <a href="https://o3o.ca/@drapor">Feed</a>
        
            &#183; 
            <a href="/about">About Me</a>
        
    
    &#183; 
    <a href="https://drapor.me">
        
    </a>

</p>
</div>



        <div class="section footer">Copyright © 2020 Gabriel Drapor, All Rights Reserved.</div>


	
     <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
  var gittalk = new Gitalk({
      clientID: 'b33898060f51f3637cdb',
      clientSecret: '264aa9f9ab82c827765c14f5df4d8195bfd26a0d',
      repo: 'gabrieldrapor.github.io',
      owner: 'GabrielDrapor',
      admin: ['GabrielDrapor'],
      id: location.pathname,      
      distractionFreeMode: false  
  })
  gittalk.render("gitalk-container")
</script>
</body>

</html>
