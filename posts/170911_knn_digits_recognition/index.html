<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<title>
Kaggle 0 手写数字识别器的探索 - DRAPORLAND
</title>











<link rel="stylesheet" href="/css/main.min.81bbafc4df93b11c1c3e2449464373c384aa4903731b4fc7a77dfcdd979e184f.css" integrity="sha256-gbuvxN&#43;TsRwcPiRJRkNzw4SqSQNzG0/Hp3383ZeeGE8=" crossorigin="anonymous" media="screen">



 

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kaggle 0 手写数字识别器的探索"/>
<meta name="twitter:description" content="最近打算开始玩Kaggle，作为入门选了一个入门级的任务Digit-Recognizer。正好在翻《机器学习实战》的时候看到可以用KNN做图像识别，于是就打算用KNN来做一个手写数字的识别器（9.13:现在要换成CNN来做了）。这也算是我第一次应用机器学习来解决比较实际的问题。此篇作为一个类似于项目日志的东西，在这个项目完成之前，应该会一直更新。"/>

<meta property="og:title" content="Kaggle 0 手写数字识别器的探索" />
<meta property="og:description" content="最近打算开始玩Kaggle，作为入门选了一个入门级的任务Digit-Recognizer。正好在翻《机器学习实战》的时候看到可以用KNN做图像识别，于是就打算用KNN来做一个手写数字的识别器（9.13:现在要换成CNN来做了）。这也算是我第一次应用机器学习来解决比较实际的问题。此篇作为一个类似于项目日志的东西，在这个项目完成之前，应该会一直更新。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://drapor.me/posts/170911_knn_digits_recognition/" />
<meta property="article:published_time" content="2017-09-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-09-11T00:00:00+00:00" />



    

    
    
    
    <title>
        
        Kaggle 0 手写数字识别器的探索
        
    </title>
    <style>
        #container .reply-content {
    	    margin-bottom: 10px;
            margin-top: 8px;
            color: #ddd;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="section" id="title">Kaggle 0 手写数字识别器的探索</div>

        
<div class="section" id="content">
    Mon Sep 11, 2017
    
    <div class="tag-container">
        
        <span class="tag">
            <a href="https://drapor.me/tags/kaggle">
                #Kaggle
            </a>
        </span>
        
    </div>
    
    <hr/>
    <p>最近打算开始玩Kaggle，作为入门选了一个入门级的任务<a href="https://www.kaggle.com/c/digit-recognizer/">Digit-Recognizer</a>。正好在翻《机器学习实战》的时候看到可以用KNN做图像识别，于是就打算用KNN来做一个手写数字的识别器（<strong>9.13:现在要换成CNN来做了</strong>）。这也算是我第一次应用机器学习来解决比较实际的问题。此篇作为一个类似于项目日志的东西，在这个项目完成之前，应该会一直更新。</p>
<h3 id="911">9.11</h3>
<p>没看书自己实现了一下KNN，算法本身也没什么复杂的，但是实现起来还是费了一番不小的功夫，动手能力还需增强啊…</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4">#!/usr/bin/env python3</span>
<span style="color:#6272a4"># -*- coding: utf-8 -*-</span>
<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;&#34;&#34;</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">@author: drapor</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;&#34;&#34;</span>

<span style="color:#ff79c6">import</span> pandas <span style="color:#ff79c6">as</span> pd
<span style="color:#ff79c6">import</span> numpy <span style="color:#ff79c6">as</span> np
<span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">Importing the data...</span><span style="color:#f1fa8c">&#39;</span>)
train_set <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>read_csv(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">train.csv</span><span style="color:#f1fa8c">&#39;</span>)
pixel <span style="color:#ff79c6">=</span> train_set<span style="color:#ff79c6">.</span>iloc[:,<span style="color:#bd93f9">1</span>:<span style="color:#bd93f9">785</span>]
label <span style="color:#ff79c6">=</span> train_set<span style="color:#ff79c6">.</span>iloc[:,<span style="color:#bd93f9">0</span>]
test_set <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>read_csv(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">test.csv</span><span style="color:#f1fa8c">&#39;</span>)
r <span style="color:#ff79c6">=</span> []
<span style="color:#ff79c6">for</span> t <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#8be9fd;font-style:italic">len</span>(test_set)):
        <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">/28000</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">%</span> (t<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>))
    a <span style="color:#ff79c6">=</span> np<span style="color:#ff79c6">.</span>array(test_set<span style="color:#ff79c6">.</span>loc[t])
    d <span style="color:#ff79c6">=</span> []
    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#8be9fd;font-style:italic">len</span>(train_set)):
        b <span style="color:#ff79c6">=</span> np<span style="color:#ff79c6">.</span>array(pixel<span style="color:#ff79c6">.</span>loc[i])
        d<span style="color:#ff79c6">.</span>append(np<span style="color:#ff79c6">.</span>dot((a<span style="color:#ff79c6">-</span>b)<span style="color:#ff79c6">.</span>T,(a<span style="color:#ff79c6">-</span>b)))
    k <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">list</span>(<span style="color:#8be9fd;font-style:italic">zip</span>(d,<span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#8be9fd;font-style:italic">len</span>(d))))
    k<span style="color:#ff79c6">.</span>sort()
    m <span style="color:#ff79c6">=</span> []
    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> k[:<span style="color:#bd93f9">10</span>]:
        m<span style="color:#ff79c6">.</span>append(label<span style="color:#ff79c6">.</span>loc[i[<span style="color:#bd93f9">1</span>]])
    r<span style="color:#ff79c6">.</span>append(<span style="color:#8be9fd;font-style:italic">sum</span>(m)<span style="color:#ff79c6">/</span><span style="color:#bd93f9">10</span>)</code></pre></div>
<p>跑了几个试了试，K选了10，有一些误差，不过效果看起来还可以。但是全量数据一起跑的时候就发现，完成任务需要的时间非常久，大概至少需要三十个小时。这当然是不能接受的，得想办法改进才行。目前初步的打算是用多进程，应该可以明显地缩短完成任务所需的时间。</p>
<hr>
<h3 id="912">9.12</h3>
<p>昨天请教了公司的组长之后得知，还可以用Deep Learning中的Pooling来降低计算的复杂度，但还是想先上多线程看看。经过一个晚上和半个上午的研究探索，终于成功地让任务以多进程的方式跑起来了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#6272a4">#!/usr/bin/env python3</span>
<span style="color:#6272a4"># -*- coding: utf-8 -*-</span>
<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;&#34;&#34;</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">Description:</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">kaggle 0 </span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">@author: drapor</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;&#34;&#34;</span>

<span style="color:#ff79c6">import</span> pandas <span style="color:#ff79c6">as</span> pd
<span style="color:#ff79c6">import</span> numpy <span style="color:#ff79c6">as</span> np
<span style="color:#ff79c6">import</span> multiprocessing
<span style="color:#ff79c6">import</span> os
<span style="color:#6272a4">#import matplotlib.pyplot as plt</span>

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">processing</span>(test_set):
    s <span style="color:#ff79c6">=</span> []
    <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">Running... pid:</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">str</span>(os<span style="color:#ff79c6">.</span>getpid()))
    <span style="color:#ff79c6">for</span> idx, df <span style="color:#ff79c6">in</span> test_set<span style="color:#ff79c6">.</span>iterrows():
        <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">/28000, pid </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">%</span> (idx, os<span style="color:#ff79c6">.</span>getpid()))
        a <span style="color:#ff79c6">=</span> np<span style="color:#ff79c6">.</span>array(df)
        d <span style="color:#ff79c6">=</span> []
        <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">42000</span>):
            b <span style="color:#ff79c6">=</span> np<span style="color:#ff79c6">.</span>array(pixel<span style="color:#ff79c6">.</span>iloc[i])
            d<span style="color:#ff79c6">.</span>append(np<span style="color:#ff79c6">.</span>dot((a<span style="color:#ff79c6">-</span>b)<span style="color:#ff79c6">.</span>T,(a<span style="color:#ff79c6">-</span>b)))
        k <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">list</span>(<span style="color:#8be9fd;font-style:italic">zip</span>(d,<span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#8be9fd;font-style:italic">len</span>(d))))
        k<span style="color:#ff79c6">.</span>sort()
        m <span style="color:#ff79c6">=</span> []
        <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> k[:<span style="color:#bd93f9">10</span>]:
            m<span style="color:#ff79c6">.</span>append(label<span style="color:#ff79c6">.</span>loc[i[<span style="color:#bd93f9">1</span>]])
        s<span style="color:#ff79c6">.</span>append([idx,<span style="color:#8be9fd;font-style:italic">sum</span>(m)<span style="color:#ff79c6">/</span><span style="color:#bd93f9">10</span>])
    <span style="color:#ff79c6">return</span> s

<span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">__main__</span><span style="color:#f1fa8c">&#39;</span>:
    <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">Importing the data...</span><span style="color:#f1fa8c">&#39;</span>)
    train_set <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>read_csv(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">train.csv</span><span style="color:#f1fa8c">&#39;</span>)
    pixel <span style="color:#ff79c6">=</span> train_set<span style="color:#ff79c6">.</span>iloc[:,<span style="color:#bd93f9">1</span>:<span style="color:#bd93f9">785</span>]
    label <span style="color:#ff79c6">=</span> train_set<span style="color:#ff79c6">.</span>iloc[:,<span style="color:#bd93f9">0</span>]
    <span style="color:#6272a4">#plt.imshow(test.reshape(28,28), cmap=plt.cm.gray)</span>
    test_set <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>read_csv(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">test.csv</span><span style="color:#f1fa8c">&#39;</span>)
    pool <span style="color:#ff79c6">=</span> multiprocessing<span style="color:#ff79c6">.</span>Pool(processes <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">16</span>)
    r <span style="color:#ff79c6">=</span> []
    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">16</span>):
        train <span style="color:#ff79c6">=</span> test_set<span style="color:#ff79c6">.</span>loc[<span style="color:#bd93f9">1750</span><span style="color:#ff79c6">*</span>i:<span style="color:#bd93f9">1750</span><span style="color:#ff79c6">*</span>(i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>)<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]
        r<span style="color:#ff79c6">.</span>append(pool<span style="color:#ff79c6">.</span>apply_async(processing,(train,)))
    pool<span style="color:#ff79c6">.</span>close()
    pool<span style="color:#ff79c6">.</span>join()
    result  <span style="color:#ff79c6">=</span> []
    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
        <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> i<span style="color:#ff79c6">.</span>get():
            result<span style="color:#ff79c6">.</span>append(j)
    result<span style="color:#ff79c6">.</span>sort()
    <span style="color:#ff79c6">with</span> <span style="color:#8be9fd;font-style:italic">open</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">result.csv</span><span style="color:#f1fa8c">&#39;</span>,<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">w</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#ff79c6">as</span> f:
        <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> result:
            f<span style="color:#ff79c6">.</span>writelines(<span style="color:#8be9fd;font-style:italic">str</span>(i[<span style="color:#bd93f9">0</span>]<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>)<span style="color:#ff79c6">+</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">,</span><span style="color:#f1fa8c">&#39;</span><span style="color:#ff79c6">+</span><span style="color:#8be9fd;font-style:italic">str</span>(<span style="color:#8be9fd;font-style:italic">round</span>(i[<span style="color:#bd93f9">1</span>]))[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">2</span>]<span style="color:#ff79c6">+</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#39;</span>)</code></pre></div>
<p>为了能够快速地完成任务，我又去AWS上租了一个c4.4xlarge，配置是16 vCPU, 2.9 GHz, Intel Xeon E5-2666v3, 30 GiB 内存，在上面把任务分成16个进程进行计算。即便如此，整个任务还是花费了大概三四个小时的时间，但总算最后还是成功地跑出来了。</p>
<p>将结果按照要求稍微整理一下就可以提交了，初次提交的分数是0.87314，预料之中。虽然准确率看起来还可以，但这个成绩在这项竞赛中的排名是1534／1625，非常的惨淡，不过这也说明改进的空间还很大。之后考虑用Pooling试试。</p>
<img src="/article_imgs/first_submission.png">
<hr>
<h3 id="913">9.13</h3>
<p>今天发现其实Pooling并不是一种可以提高精度的办法，只是一种可以降低计算复杂度的方法，如果原算法的精度本身就不高的话，Pooliing之后同样也不高，组长建议我改用CNN。我想了一下，就算调整K的值重新跑一次可能不会使准确率有明显的提升，Google了一下发现大家用KNN做手写识别，精度可能也就追求到0.8。嗯……这两天探索一下Tensorflow+CNN（之前只是知道，并没有深入了解过），尝试用这种方式解决这个问题。</p>
</div>


        
<div class="section bottom-menu">
    
<hr />
<p>


    
        <a href="/posts">back</a>
        
            &#183;
        
    

    
        
            <a href="/posts">Posts</a>
        
    
    
        
            &#183; 
            <a href="/scribble">Scribbles</a>
        
            &#183; 
            <a href="https://o3o.ca/@drapor">Feed</a>
        
            &#183; 
            <a href="/about">About Me</a>
        
    
    &#183; 
    <a href="https://drapor.me">
        
    </a>

</p>
</div>



        <div class="section footer">Copyright © 2020 Gabriel Drapor, All Rights Reserved.</div>


	
     <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
  var gittalk = new Gitalk({
      clientID: 'b33898060f51f3637cdb',
      clientSecret: '264aa9f9ab82c827765c14f5df4d8195bfd26a0d',
      repo: 'gabrieldrapor.github.io',
      owner: 'GabrielDrapor',
      admin: ['GabrielDrapor'],
      id: location.pathname,      
      distractionFreeMode: false  
  })
  gittalk.render("gitalk-container")
</script>
</body>

</html>
